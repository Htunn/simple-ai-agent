# Prometheus alert rules for Simple AI Agent AIOps
groups:
  # ── Application Health ──────────────────────────────────────────
  - name: application_health
    interval: 30s
    rules:
      - alert: AppDown
        expr: up{job="simple-ai-agent"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Simple AI Agent is down"
          description: "The application has been unreachable for more than 1 minute."

      - alert: HighErrorRate
        expr: |
          rate(http_requests_total{job="simple-ai-agent", status=~"5.."}[5m])
          / rate(http_requests_total{job="simple-ai-agent"}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High HTTP error rate"
          description: "Error rate is {{ humanizePercentage $value }} over the last 5 minutes."

      - alert: HighLatency
        expr: |
          histogram_quantile(0.99,
            rate(http_request_duration_seconds_bucket{job="simple-ai-agent"}[5m])
          ) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High HTTP latency (p99)"
          description: "p99 latency is {{ $value | humanizeDuration }} over the last 5 minutes."

  # ── Kubernetes Pod Anomalies ────────────────────────────────────
  - name: kubernetes_pods
    interval: 30s
    rules:
      - alert: PodCrashLooping
        expr: |
          rate(kube_pod_container_status_restarts_total[5m]) * 60 > 1
        for: 5m
        labels:
          severity: critical
          event_type: crash_loop
        annotations:
          summary: "Pod {{ $labels.pod }} is crash-looping"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is restarting more than once per minute."

      - alert: PodOOMKilled
        expr: |
          kube_pod_container_status_last_terminated_reason{reason="OOMKilled"} == 1
        for: 0m
        labels:
          severity: critical
          event_type: oom_killed
        annotations:
          summary: "Pod {{ $labels.pod }} was OOM-killed"
          description: "Container {{ $labels.container }} in pod {{ $labels.pod }} (ns: {{ $labels.namespace }}) was killed due to out-of-memory."

      - alert: PodNotReady
        expr: |
          kube_pod_status_ready{condition="true"} == 0
          and kube_pod_status_phase{phase=~"Pending|Running"} == 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Pod {{ $labels.pod }} is not ready"
          description: "Pod {{ $labels.pod }} in {{ $labels.namespace }} has not been ready for 5 minutes."

      - alert: DeploymentReplicasUnavailable
        expr: |
          kube_deployment_status_replicas_unavailable > 0
          and kube_deployment_spec_replicas > 0
        for: 5m
        labels:
          severity: critical
          event_type: replication_failure
        annotations:
          summary: "Deployment {{ $labels.deployment }} has unavailable replicas"
          description: "{{ $value }} replica(s) of deployment {{ $labels.deployment }} in {{ $labels.namespace }} are unavailable."

  # ── Kubernetes Nodes ────────────────────────────────────────────
  - name: kubernetes_nodes
    interval: 60s
    rules:
      - alert: NodeNotReady
        expr: |
          kube_node_status_condition{condition="Ready", status="true"} == 0
        for: 5m
        labels:
          severity: critical
          event_type: not_ready_node
        annotations:
          summary: "Node {{ $labels.node }} is NotReady"
          description: "Kubernetes node {{ $labels.node }} has been in NotReady state for more than 5 minutes."

      - alert: NodeMemoryPressure
        expr: |
          kube_node_status_condition{condition="MemoryPressure", status="true"} == 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Node {{ $labels.node }} has memory pressure"
          description: "Node {{ $labels.node }} is under memory pressure."

      - alert: NodeDiskPressure
        expr: |
          kube_node_status_condition{condition="DiskPressure", status="true"} == 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Node {{ $labels.node }} has disk pressure"
          description: "Node {{ $labels.node }} is under disk pressure."

  # ── Infrastructure ──────────────────────────────────────────────
  - name: infrastructure
    interval: 60s
    rules:
      - alert: PostgresDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL has been unreachable for more than 1 minute."

      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis is down"
          description: "Redis has been unreachable for more than 1 minute."
